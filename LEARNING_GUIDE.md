# æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ - å®Œæ•´å­¦ä¹ æŒ‡å—

> æœ¬æ–‡æ¡£é€‚åˆç¼–ç¨‹åˆå­¦è€…ï¼Œå°†è¯¦ç»†è®²è§£é¡¹ç›®çš„æ¯ä¸ªéƒ¨åˆ†ï¼Œå¸®åŠ©ä½ ç†è§£ç°ä»£ Web åº”ç”¨çš„å¼€å‘æ–¹å¼ã€‚

---

## ğŸ“š ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆè¯¦è§£](#æŠ€æœ¯æ ˆè¯¦è§£)
3. [é¡¹ç›®æ¶æ„](#é¡¹ç›®æ¶æ„)
4. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
5. [ä»£ç æ¨¡å—è¯¦è§£](#ä»£ç æ¨¡å—è¯¦è§£)
6. [è¿è¡Œæµç¨‹](#è¿è¡Œæµç¨‹)
7. [å®è·µç¤ºä¾‹](#å®è·µç¤ºä¾‹)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
9. [å­¦ä¹ è·¯çº¿](#å­¦ä¹ è·¯çº¿)

---

## é¡¹ç›®æ¦‚è¿°

### è¿™æ˜¯ä»€ä¹ˆï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªåŸºäº Python å¼€å‘çš„**æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ**ï¼ˆç±»ä¼¼ç®€åŒ–ç‰ˆçš„ ChatGPTï¼‰ï¼Œé›†æˆäº† RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æŠ€æœ¯ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

- ğŸ¤– ä¸ AI è¿›è¡Œå¯¹è¯äº¤æµ
- ğŸ’¾ ä¿å­˜èŠå¤©å†å²è®°å½•ï¼ˆMongoDBï¼‰
- ğŸ”„ æ”¯æŒå¤šè½®å¯¹è¯ï¼ˆAI èƒ½è®°ä½ä¸Šä¸‹æ–‡ï¼‰
- ğŸ“¡ å®æ—¶æµå¼è¿”å› AI å›å¤ï¼ˆåƒæ‰“å­—ä¸€æ ·é€å­—æ˜¾ç¤ºï¼‰
- ğŸ” å‘é‡æ£€ç´¢åŠŸèƒ½ï¼ˆMilvus å‘é‡æ•°æ®åº“ï¼‰
- ğŸ¯ å¤šæ¨¡æ€åµŒå…¥æ”¯æŒï¼ˆæ–‡æœ¬å’Œå›¾ç‰‡å‘é‡åŒ–ï¼‰

### é€‚ç”¨åœºæ™¯

- **å­¦ä¹ é¡¹ç›®**ï¼šäº†è§£ç°ä»£ Web åç«¯å¼€å‘
- **äºŒæ¬¡å¼€å‘**ï¼šåŸºäºæ­¤é¡¹ç›®å¼€å‘è‡ªå·±çš„èŠå¤©æœºå™¨äºº
- **æŠ€æœ¯ç ”ç©¶**ï¼šå­¦ä¹  FastAPIã€MongoDBã€å¼‚æ­¥ç¼–ç¨‹ç­‰æŠ€æœ¯

---

## æŠ€æœ¯æ ˆè¯¦è§£

### 1. FastAPI - Web æ¡†æ¶ â­â­â­

**æ˜¯ä»€ä¹ˆï¼Ÿ**
FastAPI æ˜¯ä¸€ä¸ªç°ä»£ã€é«˜æ€§èƒ½çš„ Python Web æ¡†æ¶ï¼Œç”¨äºæ„å»º APIï¼ˆåº”ç”¨ç¨‹åºæ¥å£ï¼‰ã€‚

**ç±»æ¯”ç†è§£ï¼š**
æƒ³è±¡ä½ å¼€äº†ä¸€å®¶é¤å…ï¼ˆåº”ç”¨ç¨‹åºï¼‰ï¼ŒFastAPI å°±æ˜¯æœåŠ¡å‘˜ï¼Œè´Ÿè´£ï¼š
- æ¥æ”¶å®¢äººçš„ç‚¹é¤è¯·æ±‚ï¼ˆHTTP è¯·æ±‚ï¼‰
- æŠŠèœå•å±•ç¤ºç»™å®¢äººï¼ˆAPI æ–‡æ¡£ï¼‰
- å°†è®¢å•ä¼ ç»™å¨æˆ¿ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
- æŠŠåšå¥½çš„èœé€ç»™å®¢äººï¼ˆHTTP å“åº”ï¼‰

**ä¸ºä»€ä¹ˆé€‰æ‹©å®ƒï¼Ÿ**
- âœ… è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ï¼ˆè®¿é—® `/docs` å°±èƒ½çœ‹åˆ°ï¼‰
- âœ… é€Ÿåº¦å¿«ï¼Œæ”¯æŒå¼‚æ­¥å¤„ç†
- âœ… è‡ªåŠ¨éªŒè¯è¯·æ±‚å‚æ•°
- âœ… ç±»å‹æç¤ºå‹å¥½ï¼ŒIDE æ”¯æŒå¥½

**ç¤ºä¾‹ä»£ç ï¼š**
```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/hello")  # å®šä¹‰ä¸€ä¸ªæ¥å£
async def say_hello(name: str):
    return {"message": f"Hello, {name}!"}
```

è®¿é—® `http://localhost:8000/hello?name=å¼ ä¸‰` ä¼šè¿”å›ï¼š
```json
{"message": "Hello, å¼ ä¸‰!"}
```

---

### 2. MongoDB - æ•°æ®åº“ â­â­â­

**æ˜¯ä»€ä¹ˆï¼Ÿ**
MongoDB æ˜¯ä¸€ä¸ª NoSQL æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨å’Œç®¡ç†æ•°æ®ã€‚

**ç±»æ¯”ç†è§£ï¼š**
æ•°æ®åº“å°±åƒä¸€ä¸ªæ™ºèƒ½åŒ–çš„æ–‡ä»¶æŸœï¼š
- ä¼ ç»Ÿæ•°æ®åº“ï¼ˆMySQLï¼‰ï¼šåƒExcelè¡¨æ ¼ï¼Œæ¯ä¸€è¡Œæ•°æ®æ ¼å¼å¿…é¡»ä¸€è‡´
- MongoDBï¼šåƒ JSON æ–‡ä»¶å¤¹ï¼Œå¯ä»¥çµæ´»å­˜å‚¨å„ç§ç»“æ„çš„æ•°æ®

**ä¸ºä»€ä¹ˆç”¨ MongoDBï¼Ÿ**
- âœ… çµæ´»ï¼šèŠå¤©è®°å½•é•¿çŸ­ä¸ä¸€ï¼ŒMongoDB èƒ½è½»æ¾åº”å¯¹
- âœ… æ˜“ç”¨ï¼šç›´æ¥å­˜å‚¨ JSON æ ¼å¼çš„æ•°æ®
- âœ… æ‰©å±•æ€§å¥½ï¼šé€‚åˆå¤§è§„æ¨¡æ•°æ®

**æ•°æ®ç¤ºä¾‹ï¼š**
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "session_id": "session_001",
  "user_id": "user_001",
  "messages": [
    {"role": "user", "content": "ä½ å¥½"},
    {"role": "assistant", "content": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ"}
  ],
  "create_time": "2024-12-09 13:00:00"
}
```

---

### 3. OpenAI API - AI å¤§æ¨¡å‹ â­â­â­

**æ˜¯ä»€ä¹ˆï¼Ÿ**
OpenAI æä¾›çš„ AI æ¥å£ï¼Œå¯ä»¥è°ƒç”¨ GPT ç­‰å¤§æ¨¡å‹è¿›è¡Œå¯¹è¯ã€‚

**ç±»æ¯”ç†è§£ï¼š**
å°±åƒä½¿ç”¨ç¬¬ä¸‰æ–¹å¿«é€’æœåŠ¡ï¼š
- ä½ ä¸éœ€è¦è‡ªå·±å…»å¿«é€’å‘˜ï¼ˆè®­ç»ƒæ¨¡å‹ï¼‰
- åªéœ€è¦è°ƒç”¨å¿«é€’å…¬å¸çš„æœåŠ¡ï¼ˆAPIï¼‰
- ä»˜è´¹ä½¿ç”¨å³å¯ï¼ˆæŒ‰è°ƒç”¨æ¬¡æ•°è®¡è´¹ï¼‰

**åŸºæœ¬ç”¨æ³•ï¼š**
```python
from openai import OpenAI

client = OpenAI(api_key="ä½ çš„å¯†é’¥", base_url="APIåœ°å€")

response = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=[
        {"role": "user", "content": "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ"}
    ]
)

print(response.choices[0].message.content)
```

---

### 4. MongoEngine - ORM å·¥å…· â­â­

**æ˜¯ä»€ä¹ˆï¼Ÿ**
MongoEngine æ˜¯ä¸€ä¸ª Python åº“ï¼Œè®©ä½ å¯ä»¥ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ“ä½œ MongoDBã€‚

**ç±»æ¯”ç†è§£ï¼š**
- **ä¸ç”¨ ORM**ï¼šç›´æ¥å†™ SQL è¯­å¥ï¼ˆåƒç”¨å‘½ä»¤è¡Œæ“ä½œæ–‡ä»¶ï¼‰
- **ä½¿ç”¨ ORM**ï¼šç”¨ Python å¯¹è±¡æ“ä½œï¼ˆåƒç”¨å›¾å½¢ç•Œé¢æ“ä½œæ–‡ä»¶ï¼‰

**å¯¹æ¯”ç¤ºä¾‹ï¼š**

ä¸ä½¿ç”¨ ORMï¼š
```python
db.chat_history.insert_one({
    "session_id": "123",
    "user_id": "user1",
    "messages": []
})
```

ä½¿ç”¨ ORMï¼ˆMongoEngineï¼‰ï¼š
```python
session = ChatHistory(
    session_id="123",
    user_id="user1",
    messages=[]
)
session.save()
```

---

### 5. Pydantic - æ•°æ®éªŒè¯ â­â­

**æ˜¯ä»€ä¹ˆï¼Ÿ**
Pydantic ç”¨äºå®šä¹‰æ•°æ®æ¨¡å‹å’Œè‡ªåŠ¨éªŒè¯æ•°æ®ã€‚

**ç±»æ¯”ç†è§£ï¼š**
å°±åƒé¤å…çš„èœå•ï¼š
- è§„å®šäº†æ¯é“èœå¿…é¡»æœ‰å“ªäº›é…æ–™ï¼ˆå­—æ®µï¼‰
- é…æ–™å¿…é¡»ç¬¦åˆæ ‡å‡†ï¼ˆç±»å‹éªŒè¯ï¼‰
- é¡¾å®¢ç‚¹é¤æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥ï¼ˆè‡ªåŠ¨éªŒè¯ï¼‰

**ç¤ºä¾‹ï¼š**
```python
from pydantic import BaseModel

class ChatRequest(BaseModel):
    user_id: str       # å¿…é¡»æ˜¯å­—ç¬¦ä¸²
    session_id: str
    prompt: str

# å¦‚æœä¼ å…¥çš„æ•°æ®ç±»å‹ä¸å¯¹ï¼Œä¼šè‡ªåŠ¨æŠ¥é”™
request = ChatRequest(
    user_id=123,  # âŒ é”™è¯¯ï¼šåº”è¯¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°å­—
    session_id="abc",
    prompt="ä½ å¥½"
)
```

---

### 6. Uvicorn - ASGI æœåŠ¡å™¨ â­

**æ˜¯ä»€ä¹ˆï¼Ÿ**
Uvicorn æ˜¯è¿è¡Œ FastAPI åº”ç”¨çš„æœåŠ¡å™¨ã€‚

**ç±»æ¯”ç†è§£ï¼š**
- FastAPI æ˜¯ä½ çš„åº”ç”¨ç¨‹åºï¼ˆè½¯ä»¶ï¼‰
- Uvicorn æ˜¯è¿è¡Œè¿™ä¸ªè½¯ä»¶çš„ç¯å¢ƒï¼ˆåƒ Windows ç³»ç»Ÿè¿è¡Œ exe ç¨‹åºï¼‰

**å¯åŠ¨å‘½ä»¤ï¼š**
```bash
uvicorn src.main:app --reload --port 8000
```
- `src.main:app`ï¼šå‘Šè¯‰ Uvicorn å»å“ªé‡Œæ‰¾åº”ç”¨ï¼ˆ`src/main.py` æ–‡ä»¶çš„ `app` å¯¹è±¡ï¼‰
- `--reload`ï¼šä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯
- `--port 8000`ï¼šåœ¨ 8000 ç«¯å£è¿è¡Œ

---

### 7. Milvus - å‘é‡æ•°æ®åº“ â­â­â­

**æ˜¯ä»€ä¹ˆï¼Ÿ**
Milvus æ˜¯ä¸€ä¸ªå¼€æºçš„å‘é‡æ•°æ®åº“ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨å’Œæ£€ç´¢é«˜ç»´å‘é‡æ•°æ®ï¼Œæ˜¯ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ã€‚

**ç±»æ¯”ç†è§£ï¼š**
- ä¼ ç»Ÿæ•°æ®åº“ï¼šæ ¹æ®å…³é”®å­—ç²¾ç¡®åŒ¹é…ï¼ˆlike "è‹¹æœ"ï¼‰
- å‘é‡æ•°æ®åº“ï¼šæ ¹æ®è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…ï¼ˆ"è‹¹æœ" â‰ˆ "æ°´æœ" â‰ˆ "iPhone"ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦å‘é‡æ•°æ®åº“ï¼Ÿ**
1. **è¯­ä¹‰æœç´¢**ï¼šç†è§£å†…å®¹çš„å«ä¹‰è€Œä¸ä»…ä»…æ˜¯å…³é”®å­—
2. **ç›¸ä¼¼åº¦æ£€ç´¢**ï¼šæ‰¾åˆ°æœ€ç›¸å…³çš„æ–‡æ¡£æˆ–å›¾ç‰‡
3. **RAG åº”ç”¨**ï¼šä¸º AI æä¾›ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

**å·¥ä½œåŸç†ï¼š**
```python
# 1. å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡ï¼ˆåµŒå…¥ï¼‰
text = "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ"
vector = [0.1, 0.5, 0.3, ...]  # 2048ç»´å‘é‡

# 2. å­˜å‚¨åˆ° Milvus
milvus.insert({"text": text, "embedding": vector})

# 3. æœç´¢ç›¸ä¼¼å†…å®¹
query = "AIæ˜¯ä»€ä¹ˆï¼Ÿ"
query_vector = [0.12, 0.48, 0.31, ...]
results = milvus.search(query_vector, top_k=5)  # æ‰¾åˆ°æœ€ç›¸ä¼¼çš„5æ¡
```

**é¡¹ç›®ä¸­çš„åº”ç”¨ï¼š**
- å­˜å‚¨æ–‡æ¡£å’Œå›¾ç‰‡çš„å‘é‡è¡¨ç¤º
- æ ¹æ®ç”¨æˆ·é—®é¢˜æ£€ç´¢ç›¸å…³å†…å®¹
- æ”¯æŒå¤šæ¨¡æ€æ£€ç´¢ï¼ˆæ–‡æœ¬+å›¾ç‰‡ï¼‰

---

### 8. Jina AI - åµŒå…¥æœåŠ¡ â­â­

**æ˜¯ä»€ä¹ˆï¼Ÿ**
Jina AI æä¾›å¤šæ¨¡æ€åµŒå…¥æœåŠ¡ï¼Œå¯ä»¥å°†æ–‡æœ¬ã€å›¾ç‰‡ç­‰å†…å®¹è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºã€‚

**ç±»æ¯”ç†è§£ï¼š**
å°±åƒç¿»è¯‘å®˜ï¼ŒæŠŠä¸åŒè¯­è¨€ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ï¼‰ç¿»è¯‘æˆè®¡ç®—æœºèƒ½ç†è§£çš„æ•°å­—è¯­è¨€ï¼ˆå‘é‡ï¼‰ã€‚

**æ”¯æŒçš„æ¨¡æ€ï¼š**
- æ–‡æœ¬åµŒå…¥ï¼šå°†å¥å­è½¬æ¢ä¸ºå‘é‡
- å›¾ç‰‡åµŒå…¥ï¼šå°†å›¾ç‰‡è½¬æ¢ä¸ºå‘é‡
- è·¨æ¨¡æ€æ£€ç´¢ï¼šç”¨æ–‡æœ¬æœå›¾ç‰‡ï¼Œæˆ–ç”¨å›¾ç‰‡æœæ–‡æœ¬

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
from src.third_party_service.jina import get_embeddings_async

# è·å–æ–‡æœ¬å‘é‡
result = await get_embeddings_async(
    input_type="text",
    content="A beautiful sunset"
)
text_vector = result['data'][0]['embedding']  # 2048ç»´

# è·å–å›¾ç‰‡å‘é‡
result = await get_embeddings_async(
    input_type="image_url",
    content="https://example.com/image.jpg"
)
image_vector = result['data'][0]['embedding']  # 2048ç»´

# è®¡ç®—ç›¸ä¼¼åº¦
similarity = cosine_similarity(text_vector, image_vector)
```

**é¡¹ç›®ä¸­çš„åº”ç”¨ï¼š**
- å°†ç”¨æˆ·è¾“å…¥è½¬æ¢ä¸ºå‘é‡ç”¨äºæ£€ç´¢
- å°†æ–‡æ¡£å†…å®¹å‘é‡åŒ–å­˜å‚¨åˆ° Milvus
- å®ç°è·¨æ¨¡æ€æœç´¢åŠŸèƒ½

---

### 9. RAG (æ£€ç´¢å¢å¼ºç”Ÿæˆ) æ¶æ„ â­â­â­

**æ˜¯ä»€ä¹ˆï¼Ÿ**
RAGï¼ˆRetrieval-Augmented Generationï¼‰æ˜¯ä¸€ç§ç»“åˆæ£€ç´¢å’Œç”Ÿæˆçš„ AI æŠ€æœ¯ï¼Œè®© AI èƒ½å¤ŸåŸºäºå¤–éƒ¨çŸ¥è¯†å›ç­”é—®é¢˜ã€‚

**å·¥ä½œæµç¨‹ï¼š**
```
ç”¨æˆ·æé—® â†’ å‘é‡åŒ– â†’ Milvusæ£€ç´¢ç›¸å…³æ–‡æ¡£ â†’ æ‹¼æ¥åˆ°æç¤ºè¯ â†’ AIç”Ÿæˆå›ç­”
```

**ç±»æ¯”ç†è§£ï¼š**
- ä¼ ç»Ÿ AIï¼šå‡­è®°å¿†å›ç­”ï¼ˆå¯èƒ½è¿‡æ—¶æˆ–ç¼–é€ ï¼‰
- RAG AIï¼šå…ˆæŸ¥èµ„æ–™å†å›ç­”ï¼ˆæ›´å‡†ç¡®ã€æ›´æ–°ï¼‰

**å®Œæ•´æµç¨‹å›¾ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·é—®é¢˜     â”‚ "å…¬å¸2024å¹´è¥æ”¶å¤šå°‘ï¼Ÿ"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é‡åŒ–       â”‚ [0.1, 0.5, ...]
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Milvusæ£€ç´¢   â”‚ æ‰¾åˆ°3æ¡ç›¸å…³æ–‡æ¡£
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ„å»ºæç¤ºè¯   â”‚ ä¸Šä¸‹æ–‡ + é—®é¢˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAIç”Ÿæˆ   â”‚ åŸºäºæ–‡æ¡£ç”Ÿæˆç­”æ¡ˆ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›ç”¨æˆ·     â”‚ "2024å¹´è¥æ”¶10äº¿å…ƒ"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿ï¼š**
- âœ… çŸ¥è¯†å¯æ›´æ–°ï¼ˆæ— éœ€é‡æ–°è®­ç»ƒæ¨¡å‹ï¼‰
- âœ… ç­”æ¡ˆæœ‰ä¾æ®ï¼ˆå¯è¿½æº¯æ¥æºï¼‰
- âœ… å‡å°‘å¹»è§‰ï¼ˆåŸºäºå®é™…æ–‡æ¡£ï¼‰
- âœ… éšç§ä¿æŠ¤ï¼ˆæ•æ„Ÿæ•°æ®ä¸ä¸Šä¼ æ¨¡å‹ï¼‰

---

## é¡¹ç›®æ¶æ„

### åˆ†å±‚æ¶æ„è®¾è®¡ï¼ˆRAG å¢å¼ºç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·/å®¢æˆ·ç«¯ (æµè§ˆå™¨/App)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP è¯·æ±‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API å±‚ (FastAPI è·¯ç”±)             â”‚  â† æ¥æ”¶è¯·æ±‚ï¼Œè¿”å›å“åº”
â”‚   src/api/chat.py                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Service å±‚ (ä¸šåŠ¡é€»è¾‘)             â”‚  â† å¤„ç†ä¸šåŠ¡é€»è¾‘
â”‚   â€¢ chat_service.py (å¯¹è¯ç®¡ç†)     â”‚
â”‚   â€¢ embed_service.py (å‘é‡åŒ–)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚
       â”‚              â†“
       â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚      â”‚ ç¬¬ä¸‰æ–¹æœåŠ¡å±‚          â”‚
       â”‚      â”‚ â€¢ jina.py (åµŒå…¥API)  â”‚
       â”‚      â”‚ â€¢ OpenAI (å¯¹è¯API)   â”‚
       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Repository å±‚ (æ•°æ®è®¿é—®)          â”‚  â† æ“ä½œæ•°æ®åº“
â”‚   â€¢ chat_repository (MongoDB)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚
       â†“              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ db_connå±‚    â”‚  â”‚ db_connå±‚        â”‚
â”‚ mongo.py     â”‚  â”‚ milvus.py        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚
       â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MongoDB      â”‚  â”‚ Milvus           â”‚
â”‚ (èŠå¤©è®°å½•)   â”‚  â”‚ (å‘é‡æ•°æ®)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµå‘è¯´æ˜ï¼š**

1. **å¯¹è¯æµç¨‹**ï¼š
   ```
   ç”¨æˆ·é—®é¢˜ â†’ API â†’ Service â†’ OpenAI â†’ è¿”å›ç­”æ¡ˆ
   ```

2. **RAG æ£€ç´¢æµç¨‹**ï¼š
   ```
   ç”¨æˆ·é—®é¢˜ â†’ å‘é‡åŒ–(Jina) â†’ Milvusæ£€ç´¢ â†’ æ‹¼æ¥ä¸Šä¸‹æ–‡ â†’ OpenAI â†’ ç­”æ¡ˆ
   ```

3. **æ•°æ®å­˜å‚¨æµç¨‹**ï¼š
   ```
   æ–‡æ¡£å†…å®¹ â†’ å‘é‡åŒ–(Jina) â†’ å­˜å‚¨åˆ°Milvus
   èŠå¤©è®°å½• â†’ å­˜å‚¨åˆ°MongoDB
   ```

**ä¸ºä»€ä¹ˆè¦åˆ†å±‚ï¼Ÿ**
1. **èŒè´£æ¸…æ™°**ï¼šæ¯å±‚åªåšè‡ªå·±çš„äº‹
2. **æ˜“äºç»´æŠ¤**ï¼šä¿®æ”¹æŸä¸€å±‚ä¸å½±å“å…¶ä»–å±‚
3. **ä»£ç å¤ç”¨**ï¼šRepository å¯ä»¥è¢«å¤šä¸ª Service ä½¿ç”¨
4. **å›¢é˜Ÿåä½œ**ï¼šä¸åŒäººè´Ÿè´£ä¸åŒå±‚

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. å¼‚æ­¥ç¼–ç¨‹ï¼ˆAsync/Awaitï¼‰

**åŒæ­¥ vs å¼‚æ­¥ï¼š**

```python
# åŒæ­¥ï¼šä¸€ä¸ªä¸€ä¸ªå¤„ç†ï¼Œå‰é¢çš„æ²¡å®Œæˆï¼Œåé¢çš„ç­‰å¾…
def cook_food():
    ç‚’èœ()      # éœ€è¦10åˆ†é’Ÿ
    ç…®é¥­()      # éœ€è¦20åˆ†é’Ÿ
    åšæ±¤()      # éœ€è¦15åˆ†é’Ÿ
# æ€»å…±éœ€è¦ 45 åˆ†é’Ÿ

# å¼‚æ­¥ï¼šåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡
async def cook_food():
    await asyncio.gather(
        ç‚’èœ(),   # åŒæ—¶è¿›è¡Œ
        ç…®é¥­(),   # åŒæ—¶è¿›è¡Œ
        åšæ±¤()    # åŒæ—¶è¿›è¡Œ
    )
# æ€»å…±åªéœ€è¦ 20 åˆ†é’Ÿï¼ˆæœ€é•¿çš„é‚£ä¸ªï¼‰
```

**å®é™…åº”ç”¨ï¼š**
```python
@router.post("/stream")
async def chat_stream(chat_request: ChatSessionRequest):
    # async è¡¨ç¤ºè¿™æ˜¯å¼‚æ­¥å‡½æ•°
    # await è¡¨ç¤ºç­‰å¾…è¿™ä¸ªæ“ä½œå®Œæˆ
    session = await get_chat_session(...)  
    return response
```

---

### 2. RESTful API è®¾è®¡

**REST æ˜¯ä»€ä¹ˆï¼Ÿ**
ä¸€ç§è®¾è®¡ Web API çš„é£æ ¼ï¼Œæ ¸å¿ƒç†å¿µæ˜¯"èµ„æº"ã€‚

**HTTP æ–¹æ³•ï¼š**
- `GET`ï¼šè·å–æ•°æ®ï¼ˆæŸ¥è¯¢ï¼‰
- `POST`ï¼šåˆ›å»ºæ•°æ®ï¼ˆæ–°å¢ï¼‰
- `PUT`ï¼šæ›´æ–°å…¨éƒ¨æ•°æ®ï¼ˆä¿®æ”¹ï¼‰
- `PATCH`ï¼šæ›´æ–°éƒ¨åˆ†æ•°æ®ï¼ˆä¿®æ”¹ï¼‰
- `DELETE`ï¼šåˆ é™¤æ•°æ®

**ç¤ºä¾‹ï¼š**
```
GET    /users          # è·å–æ‰€æœ‰ç”¨æˆ·
GET    /users/123      # è·å–IDä¸º123çš„ç”¨æˆ·
POST   /users          # åˆ›å»ºæ–°ç”¨æˆ·
PUT    /users/123      # æ›´æ–°ç”¨æˆ·123çš„å…¨éƒ¨ä¿¡æ¯
DELETE /users/123      # åˆ é™¤ç”¨æˆ·123
```

---

### 3. æµå¼å“åº”ï¼ˆSSE - Server-Sent Eventsï¼‰

**æ˜¯ä»€ä¹ˆï¼Ÿ**
æœåŠ¡å™¨æŒç»­å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§è¿”å›ã€‚

**ç±»æ¯”ç†è§£ï¼š**
- æ™®é€šå“åº”ï¼šä½ é—®"å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"ï¼Œæˆ‘å›ç­”"æ™´å¤©"
- æµå¼å“åº”ï¼šä½ é—®"ç»™æˆ‘è®²ä¸ªæ•…äº‹"ï¼Œæˆ‘ä¸€ä¸ªå­—ä¸€ä¸ªå­—åœ°è®²ç»™ä½ å¬

**ä»£ç ç¤ºä¾‹ï¼š**
```python
async def stream_chat(user_text: str):
    # è°ƒç”¨ AI æ¥å£ï¼Œstream=True è¡¨ç¤ºæµå¼è¿”å›
    stream = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": user_text}],
        stream=True  # å…³é”®å‚æ•°
    )
    
    # é€å—è¿”å›æ•°æ®
    for chunk in stream:
        if chunk.choices[0].delta.content:
            yield chunk.choices[0].delta.content  # yield é€æ­¥è¿”å›
```

**å‰ç«¯æ•ˆæœï¼š**
```
ä½ : è®²ä¸ªç¬‘è¯
AI: ä»
AI: ä»å‰
AI: ä»å‰æœ‰
AI: ä»å‰æœ‰ä¸€
AI: ä»å‰æœ‰ä¸€åº§
AI: ä»å‰æœ‰ä¸€åº§å±±
...ï¼ˆé€å­—æ˜¾ç¤ºï¼‰
```

---

## ä»£ç æ¨¡å—è¯¦è§£

### 1. é¡¹ç›®ç»“æ„

```
chat_built_in_memory_ztl/
â”œâ”€â”€ src/                          # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ main.py                   # åº”ç”¨å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ handlers.py               # è·¯ç”±æ³¨å†Œ
â”‚   â”œâ”€â”€ api/                      # API æ¥å£å±‚
â”‚   â”‚   â”œâ”€â”€ api.py                # è·¯ç”±æ±‡æ€»
â”‚   â”‚   â””â”€â”€ chat.py               # èŠå¤©æ¥å£
â”‚   â”œâ”€â”€ service/                  # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â””â”€â”€ chat_service.py       # èŠå¤©æœåŠ¡
â”‚   â”œâ”€â”€ repositories/             # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â””â”€â”€ chat_repository.py    # èŠå¤©æ•°æ®æ“ä½œ
â”‚   â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹å±‚
â”‚   â”‚   â””â”€â”€ mongo.py              # MongoDB æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/                  # è¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚   â””â”€â”€ chat_schemas.py       # èŠå¤©ç›¸å…³æ¨¡å‹
â”‚   â”œâ”€â”€ config/                   # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ config.py             # é…ç½®ç±»
â”‚   â”‚   â””â”€â”€ openapi_docs.py       # API æ–‡æ¡£é…ç½®
â”‚   â”œâ”€â”€ db_conn/                  # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â””â”€â”€ mongo.py              # MongoDB è¿æ¥
â”‚   â””â”€â”€ middleware/               # ä¸­é—´ä»¶
â”‚       â””â”€â”€ log.py                # æ—¥å¿—é…ç½®
â”œâ”€â”€ static/                       # é™æ€æ–‡ä»¶
â”œâ”€â”€ requirements.txt              # ä¾èµ–åŒ…åˆ—è¡¨
â””â”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
```

---

### 2. main.py - åº”ç”¨å…¥å£ ğŸš€

**ä½œç”¨ï¼š** åº”ç”¨çš„å¯åŠ¨æ–‡ä»¶ï¼Œè´Ÿè´£åˆå§‹åŒ–å’Œé…ç½®ã€‚

**å®Œæ•´ä»£ç è®²è§£ï¼š**

```python
# ç¬¬ä¸€éƒ¨åˆ†ï¼šå¯¼å…¥ä¾èµ–
import uvicorn
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
# ... å…¶ä»–å¯¼å…¥

# ç¬¬äºŒéƒ¨åˆ†ï¼šåº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š
    - å¯åŠ¨æ—¶ï¼šè¿æ¥æ•°æ®åº“
    - å…³é—­æ—¶ï¼šæ–­å¼€æ•°æ®åº“è¿æ¥
    """
    logger.info("Starting up")
    init_mongo_db()  # è¿æ¥ MongoDB
    try:
        yield  # åº”ç”¨è¿è¡ŒæœŸé—´
    finally:
        close_mongo_db()  # å…³é—­è¿æ¥
        logger.info("Application shutdown")

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ›å»º FastAPI åº”ç”¨
app = FastAPI(
    lifespan=lifespan,  # ç»‘å®šç”Ÿå‘½å‘¨æœŸ
    default_response_class=ORJSONResponse  # ä½¿ç”¨é«˜æ€§èƒ½JSON
)

# ç¬¬å››éƒ¨åˆ†ï¼šæŒ‚è½½é™æ€æ–‡ä»¶
app.mount("/static", StaticFiles(directory="static"), name="static")

# ç¬¬äº”éƒ¨åˆ†ï¼šæ³¨å†Œè·¯ç”±
include_routers(app)  # åŠ è½½æ‰€æœ‰ API æ¥å£

# ç¬¬å…­éƒ¨åˆ†ï¼šæ·»åŠ ä¸­é—´ä»¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
if settings.DEBUG:
    app.add_middleware(
        CORSMiddleware,  # è·¨åŸŸä¸­é—´ä»¶
        allow_origins=["*"],  # å…è®¸æ‰€æœ‰æ¥æºï¼ˆç”Ÿäº§ç¯å¢ƒè¦é™åˆ¶ï¼‰
        allow_methods=["*"],
        allow_headers=["*"],
    )

# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå¥åº·æ£€æŸ¥æ¥å£
@app.get("/health")
async def health_check():
    return {"status": "ok"}
```

**å…³é”®æ¦‚å¿µï¼š**

1. **ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆLifespanï¼‰**ï¼š
   - åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œçš„ä»£ç 
   - åº”ç”¨å…³é—­æ—¶æ¸…ç†èµ„æº

2. **ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰**ï¼š
   - åœ¨è¯·æ±‚åˆ°è¾¾è·¯ç”±ä¹‹å‰/ä¹‹åæ‰§è¡Œçš„ä»£ç 
   - ä¾‹å¦‚ï¼šè·¨åŸŸå¤„ç†ã€æ—¥å¿—è®°å½•ã€æƒé™éªŒè¯

3. **CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰**ï¼š
   - å…è®¸å‰ç«¯ï¼ˆå¦‚ Vueã€Reactï¼‰ä»ä¸åŒåŸŸåè®¿é—® API
   - ä¾‹å¦‚ï¼šå‰ç«¯åœ¨ `localhost:3000`ï¼Œåç«¯åœ¨ `localhost:8000`

---

### 3. chat.py - èŠå¤©æ¥å£ ğŸ’¬

```python
from fastapi import APIRouter
from sse_starlette import EventSourceResponse
from src.schemas.chat_schemas import ChatSessionRequest
from src.service.chat_service import return_model_message

router = APIRouter()

@router.post("/stream")
async def chat_stream(chat_request: ChatSessionRequest):
    """
    æµå¼èŠå¤©æ¥å£
    
    å‚æ•°ï¼š
        chat_request: åŒ…å« user_id, session_id, prompt
    
    è¿”å›ï¼š
        æµå¼å“åº”ï¼ˆSSE æ ¼å¼ï¼‰
    """
    return EventSourceResponse(
        return_model_message(chat_request),
        media_type="text/event-stream"
    )
```

**è®²è§£ï¼š**

1. **APIRouter**ï¼šè·¯ç”±å™¨ï¼Œç”¨äºç»„ç»‡ç›¸å…³çš„æ¥å£
2. **@router.post("/stream")**ï¼šè£…é¥°å™¨ï¼Œå®šä¹‰ POST æ¥å£
3. **EventSourceResponse**ï¼šè¿”å› SSE æµå¼æ•°æ®
4. **ChatSessionRequest**ï¼šPydantic æ¨¡å‹ï¼Œè‡ªåŠ¨éªŒè¯å‚æ•°

**å®Œæ•´è¯·æ±‚æµç¨‹ï¼š**
```
å®¢æˆ·ç«¯å‘é€ POST è¯·æ±‚
    â†“
FastAPI æ¥æ”¶è¯·æ±‚
    â†“
Pydantic éªŒè¯å‚æ•°ï¼ˆuser_id, session_id, promptï¼‰
    â†“
è°ƒç”¨ chat_service.return_model_message()
    â†“
æµå¼è¿”å› AI å›å¤
    â†“
å®¢æˆ·ç«¯é€å­—æ˜¾ç¤º
```

---

### 4. chat_service.py - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ğŸ§ 

**StreamChatSessionManager ç±»è¯¦è§£ï¼š**

```python
class StreamChatSessionManager:
    """æµå¼èŠå¤©ä¼šè¯ç®¡ç†å™¨"""
    
    def __init__(self, session_id, user_id, model="gpt-3.5-turbo"):
        # åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯
        self.client = OpenAI(api_key="å¯†é’¥", base_url="APIåœ°å€")
        self.session_id = session_id
        self.user_id = user_id
        self.model = model
        self.messages = []  # å­˜å‚¨èŠå¤©å†å²
    
    async def load_or_create(self):
        """åŠ è½½å†å²ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯"""
        session = await get_chat_session(self.user_id, self.session_id)
        
        if session:
            # å·²æœ‰ä¼šè¯ï¼ŒåŠ è½½å†å²æ¶ˆæ¯
            self.messages = [dict(m) for m in session.messages]
        else:
            # æ–°ä¼šè¯ï¼Œåˆ›å»ºç©ºè®°å½•
            await create_chat_session(self.user_id, self.session_id)
    
    async def stream_chat(self, user_text: str):
        """æµå¼å¯¹è¯"""
        # 1. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
        self.messages.append({
            "role": "user",
            "content": user_text
        })
        
        # 2. è°ƒç”¨ OpenAI APIï¼ˆæµå¼ï¼‰
        stream = self.client.chat.completions.create(
            model=self.model,
            messages=self.messages,
            stream=True  # å…³é”®ï¼šå¼€å¯æµå¼è¿”å›
        )
        
        # 3. é€å—è¿”å› AI å›å¤
        final_answer = ""
        for event in stream:
            chunk = event.choices[0].delta.content
            if chunk:
                final_answer += chunk
                yield chunk  # æµå¼è¿”å›
        
        # 4. ä¿å­˜å®Œæ•´çš„ AI å›å¤
        self.messages.append({
            "role": "assistant",
            "content": final_answer
        })
        
        # 5. ä¿å­˜åˆ°æ•°æ®åº“
        await self._save_message()
```

**é‡ç‚¹ç†è§£ï¼š**

1. **ä¸ºä»€ä¹ˆè¦ä¿å­˜ messages åˆ—è¡¨ï¼Ÿ**
   - AI éœ€è¦ä¸Šä¸‹æ–‡æ‰èƒ½ç†è§£å¯¹è¯
   - ä¾‹å¦‚ï¼šä½ è¯´"æˆ‘å«å¼ ä¸‰"ï¼Œåé¢é—®"æˆ‘å«ä»€ä¹ˆ"ï¼ŒAI èƒ½è®°ä½

2. **æµå¼è¿”å›çš„å¥½å¤„ï¼š**
   - ç”¨æˆ·ä½“éªŒå¥½ï¼ˆä¸ç”¨ç­‰å¾…ï¼Œé€å­—æ˜¾ç¤ºï¼‰
   - å‡å°‘ç­‰å¾…ç„¦è™‘
   - é€‚åˆé•¿æ–‡æœ¬ç”Ÿæˆ

3. **yield å…³é”®å­—ï¼š**
   - ç±»ä¼¼ returnï¼Œä½†ä¸ä¼šç»“æŸå‡½æ•°
   - æ¯æ¬¡ yield è¿”å›ä¸€å—æ•°æ®ï¼Œç„¶åç»§ç»­æ‰§è¡Œ

---

### 5. chat_repository.py - æ•°æ®è®¿é—®å±‚ ğŸ’¾

```python
async def create_chat_session(user_id: str, session_id: str):
    """åˆ›å»ºæ–°çš„èŠå¤©ä¼šè¯"""
    session = ChatHistory.objects.create(
        session_id=session_id,
        user_id=user_id,
        messages=[]
    )
    return session

async def get_chat_session(session_id: str, user_id: str):
    """è·å–èŠå¤©ä¼šè¯"""
    try:
        return ChatHistory.objects(
            session_id=session_id,
            user_id=user_id
        ).first()  # è¿”å›ç¬¬ä¸€æ¡åŒ¹é…çš„è®°å½•
    except Exception as e:
        logger.error(f"Error: {e}")
        return None

async def update_chat_session(user_id: str, session_id: str, messages: List):
    """æ›´æ–°èŠå¤©è®°å½•"""
    session = ChatHistory.objects.get(user_id=user_id, session_id=session_id)
    session.messages = messages
    session.save()
    return session
```

**è®¾è®¡æ¨¡å¼ï¼šRepository æ¨¡å¼**

**ä¼˜ç‚¹ï¼š**
- ä¸šåŠ¡é€»è¾‘ï¼ˆServiceï¼‰ä¸éœ€è¦çŸ¥é“æ•°æ®åº“ç»†èŠ‚
- æ–¹ä¾¿åˆ‡æ¢æ•°æ®åº“ï¼ˆä» MongoDB æ¢åˆ° MySQLï¼Œåªéœ€ä¿®æ”¹è¿™ä¸€å±‚ï¼‰
- ä¾¿äºæµ‹è¯•ï¼ˆå¯ä»¥ mock è¿™ä¸€å±‚ï¼‰

---

### 6. mongo.py - æ•°æ®æ¨¡å‹ ğŸ“Š

```python
class BaseDocument(Document):
    """
    åŸºç¡€æ–‡æ¡£ç±»
    æ‰€æœ‰æ¨¡å‹éƒ½ç»§æ‰¿å®ƒï¼Œè‡ªåŠ¨æ·»åŠ åˆ›å»º/æ›´æ–°æ—¶é—´
    """
    meta = {'abstract': True}  # æŠ½è±¡ç±»ï¼Œä¸ä¼šåˆ›å»ºå¯¹åº”çš„é›†åˆ
    
    create_time = DateTimeField()  # åˆ›å»ºæ—¶é—´
    update_time = DateTimeField()  # æ›´æ–°æ—¶é—´
    
    def save(self, *args, **kwargs):
        """é‡å†™ä¿å­˜æ–¹æ³•ï¼Œè‡ªåŠ¨è®¾ç½®æ—¶é—´"""
        if not self.create_time:
            self.create_time = datetime.datetime.now()
        self.update_time = datetime.datetime.now()
        return super().save(*args, **kwargs)


class ChatHistory(BaseDocument):
    """èŠå¤©è®°å½•æ¨¡å‹"""
    meta = {
        'collection': 'chat_history',  # MongoDB é›†åˆå
        'indexes': ['session_id']       # ç´¢å¼•ï¼ˆåŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼‰
    }
    
    session_id = StringField()  # ä¼šè¯ID
    user_id = StringField()     # ç”¨æˆ·ID
    messages = ListField(default=list)  # æ¶ˆæ¯åˆ—è¡¨
    
    def to_dict(self):
        """è½¬æ¢ä¸ºå­—å…¸ï¼ˆæ–¹ä¾¿åºåˆ—åŒ–ä¸º JSONï¼‰"""
        data = self.to_mongo().to_dict()
        if '_id' in data:
            data['_id'] = str(data['_id'])  # ObjectId è½¬å­—ç¬¦ä¸²
        return data
```

**ORM çš„å¥½å¤„ï¼š**
- ç”¨ Python ç±»ä»£è¡¨æ•°æ®åº“è¡¨
- è‡ªåŠ¨å¤„ç† CRUD æ“ä½œ
- ç±»å‹å®‰å…¨

**æ•°æ®åº“ç´¢å¼•ï¼š**
- åƒä¹¦çš„ç›®å½•ï¼ŒåŠ å¿«æŸ¥æ‰¾é€Ÿåº¦
- `indexes=['session_id']` è¡¨ç¤ºæ ¹æ® session_id æŸ¥è¯¢ä¼šå¾ˆå¿«

---

### 7. config.py - é…ç½®ç®¡ç† âš™ï¸

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    """åº”ç”¨é…ç½®ç±»"""
    
    # è°ƒè¯•æ¨¡å¼
    DEBUG: bool = True
    
    # MongoDB é…ç½®
    MONGO_DB: str = "chat_agent_db"
    MONGO_HOST: str = "localhost"
    MONGO_PORT: int = 27017
    MONGO_USER: str = ""
    MONGO_PASSWORD: str = ""
    
    # æ—¥å¿—é…ç½®
    log_rotation: str = "100 MB"    # æ—¥å¿—æ–‡ä»¶å¤§å°é™åˆ¶
    log_retention: str = "7 days"   # æ—¥å¿—ä¿ç•™æ—¶é—´
    
    class Config:
        env_file = ".env"  # ä» .env æ–‡ä»¶è¯»å–é…ç½®

settings = Settings()  # åˆ›å»ºå…¨å±€é…ç½®å¯¹è±¡
```

**ç¯å¢ƒå˜é‡çš„å¥½å¤„ï¼š**
- æ•æ„Ÿä¿¡æ¯ä¸å†™åœ¨ä»£ç é‡Œï¼ˆå¦‚å¯†ç ã€API Keyï¼‰
- ä¸åŒç¯å¢ƒç”¨ä¸åŒé…ç½®ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
- `.env` æ–‡ä»¶ä¸æäº¤åˆ° Git

**ä½¿ç”¨æ–¹å¼ï¼š**
```python
from src.config.config import settings

print(settings.MONGO_HOST)  # è¯»å–é…ç½®
```

---

## è¿è¡Œæµç¨‹

### å®Œæ•´è¯·æ±‚å¤„ç†æµç¨‹

```
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚
   POST http://localhost:8000/chat/stream
   Body: {"user_id": "user1", "session_id": "s1", "prompt": "ä½ å¥½"}
   
   â†“

2. Uvicorn æ¥æ”¶ HTTP è¯·æ±‚
   
   â†“

3. FastAPI è·¯ç”±åŒ¹é…
   æ‰¾åˆ° @router.post("/stream") å¯¹åº”çš„å‡½æ•°
   
   â†“

4. Pydantic éªŒè¯å‚æ•°
   æ£€æŸ¥ user_id, session_id, prompt æ˜¯å¦ç¬¦åˆè¦æ±‚
   
   â†“

5. è°ƒç”¨ Service å±‚
   return_model_message(chat_request)
   
   â†“

6. Service åˆå§‹åŒ–ä¼šè¯ç®¡ç†å™¨
   StreamChatSessionManager(session_id, user_id)
   
   â†“

7. åŠ è½½å†å²ä¼šè¯
   ä» MongoDB æŸ¥è¯¢ä¹‹å‰çš„èŠå¤©è®°å½•
   
   â†“

8. è°ƒç”¨ OpenAI API
   å‘é€å†å²æ¶ˆæ¯ + æ–°æ¶ˆæ¯ç»™ GPT
   
   â†“

9. æµå¼è¿”å› AI å›å¤
   é€å­—è¿”å›ç»™å®¢æˆ·ç«¯
   
   â†“

10. ä¿å­˜å®Œæ•´å¯¹è¯
    å°†æ–°çš„æ¶ˆæ¯ä¿å­˜åˆ° MongoDB
    
   â†“

11. å“åº”å®Œæˆ
    å®¢æˆ·ç«¯æ”¶åˆ°å®Œæ•´å›å¤
```

---

### æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ {"user_id": "user1", "prompt": "ä½ å¥½"}
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API å±‚        â”‚  chat.py
â”‚  éªŒè¯å‚æ•°      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service å±‚    â”‚  chat_service.py
â”‚  ä¸šåŠ¡é€»è¾‘      â”‚  1. æŸ¥å†å² 2. è°ƒAI 3. ä¿å­˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Repositoryå±‚  â”‚  chat_repository.py
â”‚  æ•°æ®åº“æ“ä½œ    â”‚  CRUD æ“ä½œ
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MongoDB       â”‚  å­˜å‚¨èŠå¤©è®°å½•
â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®è·µç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå•æ¬¡å¯¹è¯

**è¯·æ±‚ï¼š**
```bash
curl -X POST "http://localhost:8000/chat/stream" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user_001",
    "session_id": "session_001",
    "prompt": "ä»€ä¹ˆæ˜¯Pythonï¼Ÿ"
  }'
```

**è¿”å›ï¼ˆSSE æ ¼å¼ï¼‰ï¼š**
```
event: add
data: {"session_id":"session_001","user_id":"user_001","data":{"content":"Python"}}

event: add
data: {"session_id":"session_001","user_id":"user_001","data":{"content":"æ˜¯"}}

event: add
data: {"session_id":"session_001","user_id":"user_001","data":{"content":"ä¸€"}}

event: add
data: {"session_id":"session_001","user_id":"user_001","data":{"content":"ç§"}}

...ï¼ˆé€å­—è¿”å›ï¼‰

event: finish
data: {"session_id":"session_001","user_id":"user_001","data":{"content":"\n\n"}}
```

---

### ç¤ºä¾‹ 2ï¼šå¤šè½®å¯¹è¯ï¼ˆæµ‹è¯•è®°å¿†ï¼‰

**ç¬¬ä¸€è½®ï¼š**
```json
{
  "user_id": "user_001",
  "session_id": "session_002",
  "prompt": "æˆ‘å«å¼ ä¸‰ï¼Œä»Šå¹´25å²"
}
```

**AI å›å¤ï¼š**
```
ä½ å¥½å¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚25å²æ­£æ˜¯å¹´è½»æœ‰æ´»åŠ›çš„å¹´çºª...
```

**ç¬¬äºŒè½®ï¼ˆåŒä¸€ä¸ª session_idï¼‰ï¼š**
```json
{
  "user_id": "user_001",
  "session_id": "session_002",
  "prompt": "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿå¤šå¤§äº†ï¼Ÿ"
}
```

**AI å›å¤ï¼š**
```
ä½ å«å¼ ä¸‰ï¼Œä»Šå¹´25å²ã€‚
```

**æ•°æ®åº“ä¸­çš„è®°å½•ï¼š**
```json
{
  "session_id": "session_002",
  "user_id": "user_001",
  "messages": [
    {"role": "user", "content": "æˆ‘å«å¼ ä¸‰ï¼Œä»Šå¹´25å²"},
    {"role": "assistant", "content": "ä½ å¥½å¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ..."},
    {"role": "user", "content": "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿå¤šå¤§äº†ï¼Ÿ"},
    {"role": "assistant", "content": "ä½ å«å¼ ä¸‰ï¼Œä»Šå¹´25å²ã€‚"}
  ]
}
```

---

### ç¤ºä¾‹ 3ï¼šå‰ç«¯é›†æˆï¼ˆJavaScriptï¼‰

```javascript
// ä½¿ç”¨ EventSource æ¥æ”¶æµå¼æ•°æ®
const eventSource = new EventSource('http://localhost:8000/chat/stream');

eventSource.onmessage = function(event) {
  const data = JSON.parse(event.data);
  
  if (event.event === 'add') {
    // é€å­—è¿½åŠ åˆ°é¡µé¢
    document.getElementById('chat').innerHTML += data.data.content;
  } else if (event.event === 'finish') {
    // å¯¹è¯ç»“æŸ
    eventSource.close();
  }
};

eventSource.onerror = function(error) {
  console.error('è¿æ¥é”™è¯¯:', error);
  eventSource.close();
};
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦ç”¨å¼‚æ­¥ï¼ˆasync/awaitï¼‰ï¼Ÿ

**ç­”ï¼š** æé«˜å¹¶å‘æ€§èƒ½ã€‚

- **åŒæ­¥**ï¼šä¸€ä¸ªè¯·æ±‚å¤„ç†å®Œæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ª
- **å¼‚æ­¥**ï¼šå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚

**ç¤ºä¾‹ï¼š**
```python
# åŒæ­¥ï¼šæ¯æ¬¡åªèƒ½æœåŠ¡ä¸€ä¸ªç”¨æˆ·
def handle_request():
    time.sleep(10)  # ç­‰å¾… 10 ç§’
    return "OK"

# å¼‚æ­¥ï¼šå¯ä»¥åŒæ—¶æœåŠ¡å¤šä¸ªç”¨æˆ·
async def handle_request():
    await asyncio.sleep(10)  # ç­‰å¾…æœŸé—´å¯ä»¥å¤„ç†å…¶ä»–è¯·æ±‚
    return "OK"
```

---

### Q2: æµå¼å“åº”å’Œæ™®é€šå“åº”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**æ™®é€šå“åº”ï¼š**
```
å®¢æˆ·ç«¯ç­‰å¾… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 30ç§’ â”€â”€â”€â†’ æ”¶åˆ°å®Œæ•´å›å¤
```

**æµå¼å“åº”ï¼š**
```
å®¢æˆ·ç«¯ â”€â†’ ç«‹å³å¼€å§‹æ¥æ”¶ â”€â†’ é€å­—æ˜¾ç¤º â”€â†’ ä½“éªŒæ›´å¥½
```

**ä»£ç å¯¹æ¯”ï¼š**

```python
# æ™®é€šå“åº”
@app.post("/chat")
async def chat(request):
    response = await call_ai(request.prompt)
    return {"answer": response}  # ä¸€æ¬¡æ€§è¿”å›

# æµå¼å“åº”
@app.post("/chat/stream")
async def chat_stream(request):
    async for chunk in call_ai_stream(request.prompt):
        yield chunk  # é€å—è¿”å›
```

---

### Q3: ä¸ºä»€ä¹ˆè¦åˆ†è¿™ä¹ˆå¤šå±‚ï¼ˆAPIã€Serviceã€Repositoryï¼‰ï¼Ÿ

**ç­”ï¼š** èŒè´£åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤ã€‚

**ç±»æ¯”ï¼š**
- **é¤å…**ï¼šæœåŠ¡å‘˜ï¼ˆAPIï¼‰ã€å¨å¸ˆï¼ˆServiceï¼‰ã€ä»“åº“ç®¡ç†å‘˜ï¼ˆRepositoryï¼‰
- å¦‚æœæœåŠ¡å‘˜è¿˜è¦åšèœã€ç®¡ä»“åº“ï¼Œæ•ˆç‡ä½ä¸”å®¹æ˜“å‡ºé”™

**å¥½å¤„ï¼š**
1. **å•ä¸€èŒè´£**ï¼šæ¯å±‚åªåšä¸€ä»¶äº‹
2. **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥å•ç‹¬æµ‹è¯•æ¯ä¸€å±‚
3. **å¤ç”¨æ€§**ï¼šRepository å¯ä»¥è¢«å¤šä¸ª Service ä½¿ç”¨
4. **å›¢é˜Ÿåä½œ**ï¼šå‰ç«¯å¼€å‘ã€åç«¯å¼€å‘ã€æ•°æ®åº“ç®¡ç†å‘˜å„å¸å…¶èŒ

---

### Q4: MongoDB å’Œ MySQL æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| ç‰¹æ€§ | MongoDB | MySQL |
|------|---------|-------|
| **ç±»å‹** | NoSQLï¼ˆæ–‡æ¡£æ•°æ®åº“ï¼‰ | SQLï¼ˆå…³ç³»å‹æ•°æ®åº“ï¼‰ |
| **æ•°æ®æ ¼å¼** | JSON æ–‡æ¡£ | è¡¨æ ¼ï¼ˆè¡Œå’Œåˆ—ï¼‰ |
| **çµæ´»æ€§** | é«˜ï¼ˆå­—æ®µå¯å˜ï¼‰ | ä½ï¼ˆå¿…é¡»å®šä¹‰è¡¨ç»“æ„ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | èŠå¤©è®°å½•ã€æ—¥å¿—ã€éç»“æ„åŒ–æ•°æ® | ç”¨æˆ·ä¿¡æ¯ã€è®¢å•ã€ç»“æ„åŒ–æ•°æ® |
| **æŸ¥è¯¢è¯­è¨€** | MongoDB æŸ¥è¯¢è¯­æ³• | SQL è¯­å¥ |

**ç¤ºä¾‹å¯¹æ¯”ï¼š**

**MySQL è¡¨ç»“æ„ï¼ˆå›ºå®šï¼‰ï¼š**
```sql
CREATE TABLE users (
  id INT,
  name VARCHAR(50),
  age INT
);
```

**MongoDB æ–‡æ¡£ï¼ˆçµæ´»ï¼‰ï¼š**
```json
// æ–‡æ¡£1
{"name": "å¼ ä¸‰", "age": 25}

// æ–‡æ¡£2ï¼ˆå¯ä»¥æœ‰ä¸åŒçš„å­—æ®µï¼‰
{"name": "æå››", "age": 30, "hobby": "ç¼–ç¨‹", "address": {...}}
```

---

### Q5: ä»€ä¹ˆæ˜¯ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰ï¼Ÿ

**ç­”ï¼š** åœ¨è¯·æ±‚å¤„ç†å‰/åæ‰§è¡Œçš„ä»£ç ã€‚

**ç±»æ¯”ï¼š**
è¿›å…¥æ™¯åŒºéœ€è¦ï¼š
1. ä¹°ç¥¨ï¼ˆè®¤è¯ä¸­é—´ä»¶ï¼‰
2. å®‰æ£€ï¼ˆå®‰å…¨ä¸­é—´ä»¶ï¼‰
3. ç™»è®°ï¼ˆæ—¥å¿—ä¸­é—´ä»¶ï¼‰
4. æ‰èƒ½è¿›å»ç©ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰

**ä»£ç ç¤ºä¾‹ï¼š**
```python
# CORS ä¸­é—´ä»¶ï¼šå…è®¸è·¨åŸŸè®¿é—®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
)

# è‡ªå®šä¹‰ä¸­é—´ä»¶
@app.middleware("http")
async def log_requests(request, call_next):
    print(f"æ”¶åˆ°è¯·æ±‚: {request.url}")
    response = await call_next(request)
    print(f"è¿”å›å“åº”: {response.status_code}")
    return response
```

---

## å­¦ä¹ è·¯çº¿

### é˜¶æ®µ 1ï¼šåŸºç¡€çŸ¥è¯†ï¼ˆ1-2å‘¨ï¼‰

**å­¦ä¹ å†…å®¹ï¼š**
1. **Python åŸºç¡€**
   - å˜é‡ã€å‡½æ•°ã€ç±»
   - åˆ—è¡¨ã€å­—å…¸
   - å¼‚æ­¥ç¼–ç¨‹ï¼ˆasync/awaitï¼‰

2. **HTTP åè®®**
   - GETã€POST ç­‰æ–¹æ³•
   - è¯·æ±‚å¤´ã€è¯·æ±‚ä½“
   - çŠ¶æ€ç ï¼ˆ200ã€404ã€500ï¼‰

3. **JSON æ ¼å¼**
   - ç†è§£ JSON è¯­æ³•
   - Python ä¸­çš„ json æ¨¡å—

**æ¨èèµ„æºï¼š**
- Python å®˜æ–¹æ•™ç¨‹
- èœé¸Ÿæ•™ç¨‹ HTTP éƒ¨åˆ†
- FastAPI å®˜æ–¹æ–‡æ¡£ï¼ˆä¸­æ–‡ï¼‰

---

### é˜¶æ®µ 2ï¼šæ¡†æ¶å­¦ä¹ ï¼ˆ2-3å‘¨ï¼‰

**å­¦ä¹ å†…å®¹ï¼š**
1. **FastAPI**
   - è·¯ç”±å®šä¹‰
   - è¯·æ±‚å‚æ•°éªŒè¯
   - å“åº”æ¨¡å‹
   - ä¾èµ–æ³¨å…¥

2. **MongoDB**
   - åŸºæœ¬æ¦‚å¿µï¼ˆæ–‡æ¡£ã€é›†åˆï¼‰
   - CRUD æ“ä½œ
   - MongoEngine ORM

3. **Pydantic**
   - æ•°æ®æ¨¡å‹å®šä¹‰
   - æ•°æ®éªŒè¯

**å®è·µé¡¹ç›®ï¼š**
- å®ç°ä¸€ä¸ªç®€å•çš„ TODO API
- å¢åˆ æ”¹æŸ¥å¾…åŠäº‹é¡¹

---

### é˜¶æ®µ 3ï¼šé¡¹ç›®å®æˆ˜ï¼ˆ3-4å‘¨ï¼‰

**å­¦ä¹ å†…å®¹ï¼š**
1. **ç†è§£æœ¬é¡¹ç›®**
   - é€ä¸ªæ–‡ä»¶é˜…è¯»ä»£ç 
   - è¿è¡Œå¹¶æµ‹è¯•é¡¹ç›®
   - ä¿®æ”¹éƒ¨åˆ†åŠŸèƒ½

2. **æ‰©å±•åŠŸèƒ½**
   - æ·»åŠ ç”¨æˆ·è®¤è¯
   - å®ç°ä¼šè¯åˆ—è¡¨æŸ¥è¯¢
   - æ·»åŠ åˆ é™¤ä¼šè¯åŠŸèƒ½
   - æ”¯æŒå¤šç§ AI æ¨¡å‹åˆ‡æ¢

3. **éƒ¨ç½²ä¸Šçº¿**
   - Docker å®¹å™¨åŒ–
   - äº‘æœåŠ¡å™¨éƒ¨ç½²
   - åŸŸåå’Œ HTTPS

---

### é˜¶æ®µ 4ï¼šè¿›é˜¶å­¦ä¹ ï¼ˆé•¿æœŸï¼‰

**æ–¹å‘é€‰æ‹©ï¼š**
1. **åç«¯è¿›é˜¶**
   - å¾®æœåŠ¡æ¶æ„
   - æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedisã€RabbitMQï¼‰
   - ç¼“å­˜ç­–ç•¥
   - æ€§èƒ½ä¼˜åŒ–

2. **AI åº”ç”¨**
   - Langchain æ¡†æ¶
   - å‘é‡æ•°æ®åº“
   - RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰
   - Agent å¼€å‘

3. **å…¨æ ˆå¼€å‘**
   - å­¦ä¹ å‰ç«¯ï¼ˆVue/Reactï¼‰
   - å¼€å‘å®Œæ•´çš„èŠå¤©ç•Œé¢
   - WebSocket å®æ—¶é€šä¿¡

---

## æ¨èå­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [FastAPI ä¸­æ–‡æ–‡æ¡£](https://fastapi.tiangolo.com/zh/)
- [MongoDB å®˜æ–¹æ•™ç¨‹](https://www.mongodb.com/docs/manual/)
- [OpenAI API æ–‡æ¡£](https://platform.openai.com/docs/)

### è§†é¢‘æ•™ç¨‹
- Bç«™æœç´¢ï¼šFastAPI æ•™ç¨‹
- Bç«™æœç´¢ï¼šMongoDB å…¥é—¨
- YouTube: FastAPI Full Course

### ä¹¦ç±æ¨è
- ã€ŠPython Webå¼€å‘å®æˆ˜ã€‹
- ã€ŠMongoDBæƒå¨æŒ‡å—ã€‹
- ã€Šæ·±åº¦å­¦ä¹ åº”ç”¨å¼€å‘ã€‹

### å®æˆ˜ç»ƒä¹ 
- LeetCode Python é¢˜ç›®
- GitHub ä¸Šçš„å¼€æºé¡¹ç›®
- Kaggle æ•°æ®ç§‘å­¦ç«èµ›

---

## ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³å¯ä»¥å°è¯•çš„ä¿®æ”¹ï¼š

1. **ä¿®æ”¹ AI å›å¤**
   - ä¿®æ”¹ `chat_service.py` ä¸­çš„ system prompt
   - è®© AI æ‰®æ¼”ä¸åŒè§’è‰²

2. **æ·»åŠ æ–°æ¥å£**
   ```python
   @router.get("/sessions/{user_id}")
   async def get_user_sessions(user_id: str):
       """è·å–ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯"""
       sessions = ChatHistory.objects(user_id=user_id)
       return [s.to_dict() for s in sessions]
   ```

3. **ç¾åŒ– API æ–‡æ¡£**
   - åœ¨è·¯ç”±å‡½æ•°ä¸­æ·»åŠ è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
   - ä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨ `/docs` é¡µé¢

4. **æ·»åŠ é”™è¯¯å¤„ç†**
   ```python
   from fastapi import HTTPException
   
   @router.post("/stream")
   async def chat_stream(chat_request: ChatSessionRequest):
       if not chat_request.prompt:
           raise HTTPException(status_code=400, detail="æç¤ºè¯ä¸èƒ½ä¸ºç©º")
       # ...
   ```

---

## æ€»ç»“

é€šè¿‡å­¦ä¹ æœ¬é¡¹ç›®ï¼Œä½ å°†æŒæ¡ï¼š

âœ… **Web å¼€å‘åŸºç¡€**ï¼šHTTPã€APIã€RESTful è®¾è®¡
âœ… **Python ç°ä»£å¼€å‘**ï¼šFastAPIã€å¼‚æ­¥ç¼–ç¨‹ã€ç±»å‹æç¤º
âœ… **æ•°æ®åº“åº”ç”¨**ï¼šMongoDBã€ORMã€æ•°æ®å»ºæ¨¡
âœ… **AI é›†æˆ**ï¼šOpenAI APIã€æµå¼å“åº”ã€å¯¹è¯ç®¡ç†
âœ… **è½¯ä»¶å·¥ç¨‹å®è·µ**ï¼šåˆ†å±‚æ¶æ„ã€é…ç½®ç®¡ç†ã€æ—¥å¿—è®°å½•

**è®°ä½ï¼š** ç¼–ç¨‹æ˜¯å®è·µçš„è‰ºæœ¯ï¼Œå¤šåŠ¨æ‰‹ã€å¤šæ€è€ƒã€å¤šæé—®ï¼

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2025-12-09  
**ä½œè€…ï¼š** èµµå¤©é¾™ã€å°èƒƒè¢‹æ—å­  
**è®¸å¯ï¼š** MIT License

å¦‚æœ‰ç–‘é—®ï¼Œæ¬¢è¿æ Issue æˆ– PRï¼ğŸ‰
